<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>action.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Tutorials</li><li class="nav-item"><a href="tutorial-cheatsheet.html">CosmicLink cheatsheet</a></li><li class="nav-item"><a href="tutorial-cheatsheet2.html">Queries cheatsheet</a></li><li class="nav-item"><a href="tutorial-specifications.html">Queries specifications</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="CosmicLink.html">CosmicLink</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="CosmicLink.html#addAliases">addAliases</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="CosmicLink.html#addFormatHandler">addFormatHandler</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="CosmicLink.html#clearClickHandler">clearClickHandler</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="CosmicLink.html#getSigners">getSigners</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="CosmicLink.html#getSource">getSource</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="CosmicLink.html#getSourceAccount">getSourceAccount</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="CosmicLink.html#hasSigned">hasSigned</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="CosmicLink.html#hasSigner">hasSigner</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="CosmicLink.html#parse">parse</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="CosmicLink.html#removeAliases">removeAliases</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="CosmicLink.html#removeFormatHandler">removeFormatHandler</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="CosmicLink.html#selectNetwork">selectNetwork</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="CosmicLink.html#send">send</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="CosmicLink.html#setClickHandler">setClickHandler</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="CosmicLink.html#sign">sign</a></span></li><li class="nav-heading">Modules</li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-defaults.html">defaults</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-defaults.html#.addAliases">addAliases</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-defaults.html#.addFormatHandler">addFormatHandler</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-defaults.html#.clearClickHandler">clearClickHandler</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-defaults.html#.removeAliases">removeAliases</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-defaults.html#.removeFormatHandler">removeFormatHandler</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-defaults.html#.setClickHandler">setClickHandler</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-specs.html">specs</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">action.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict'
/**
 * Contains the action methods for CosmicLink.
 *
 * @private
 */
const action = exports

const helpers = require('./helpers')
const status = require('./status')
const resolve = require('./resolve')
const parse = require('./parse')
const format = require('./format')
const event = require('./event')

/**
 * Sign a CosmicLink object using `...keypairs_or_preimage`.
 * Returns a promise that resolve to the signed transaction. The CosmicLink
 * data are refreshed at promise resolution.
 *
 * @example
 * cosmicLink.sign(keypair1, keypair2)
 *  .then(function () { return cosmicLink.send() }
 *  .then(console.log)
 *  .catch(console.error)
 *
 * @alias CosmicLink#sign
 * @param {...Keypair|preimage} keypairs_or_preimage One or more keypair, or a
 *     preimage
 * @returns {Promise} Signed Transaction object
 */
action.sign = async function (cosmicLink, ...keypairs_or_preimage) {
  if (cosmicLink.status) throw new Error("Can't sign invalid transaction")
  return makeSigningPromise(cosmicLink, ...keypairs_or_preimage)
}

async function makeSigningPromise (cosmicLink, ...value) {
  const transaction = await cosmicLink.getTransaction()
  let allFine = true

  if (typeof value[0] !== 'string') {
    for (let index in value) {
      const keypair = value[index]
      const publicKey = keypair.publicKey()

      if (!await cosmicLink.hasSigner(publicKey)) {
        const short = helpers.shorter(publicKey)
        status.error(cosmicLink, 'Not a legit signer: ' + short)
        allFine = false
        continue
      }

      if (hasSigned(transaction, keypair)) continue

      try {
        transaction.sign(keypair)
      } catch (error) {
        console.error(error)
        const short = helpers.shorter(publicKey)
        status.error(cosmicLink, 'Failed to sign with key: ' + short)
        allFine = false
        continue
      }
    }
  } else if (type === 'preimage') {
    try {
      transaction.signHashX(value[0])
    } catch (error) {
      console.error(error)
      const short = helpers.shorter(value[0])
      status.error(cosmicLink, 'Failed to sign with preimage: ' + short, 'throw')
    }
  }

  parse.typeTowardAll(cosmicLink, 'transaction', transaction)
  parse.makeConverter(cosmicLink, 'xdr', 'query')
  parse.makeConverter(cosmicLink, 'query', 'uri')

  cosmicLink.getSigners = helpers.delay(() => resolve.signers(cosmicLink))

  if (cosmicLink._signersNode) format.signatures(cosmicLink)

  event.callFormatHandlers(cosmicLink)

  if (!allFine) throw new Error('Some signers where invalid')
  else return transaction
}

function hasSigned (transaction, keypair) {
  const keypairHint = keypair.signatureHint().toString('base64')
  const signatures = transaction.signatures

  for (let index in signatures) {
    const hint = signatures[index].hint().toString('base64')
    if (hint === keypairHint) return true
  }

  return false
}

/**
 * Send CosmicLink transaction to `server`, or to `cosmicLink.server`. It should
 * have been signed beforehand to be validated.
 *
 * Returns a promise that resolve with horizon server response when transaction
 * is accepted, or that reject to horizon server response if transaction is
 * rejected.
 *
 * @example
 * cosmicLink.send()
 *   .then(console.log)
 *   .catch(console.error)
 *
 * @alias CosmicLink#send
 * @param {Server} [server=cosmicLink.server] A Stellar SDK [Server]{@link https://stellar.github.io/js-stellar-sdk/Server.html} object
 * @return {Promise} The server response
 */
action.send = async function (cosmicLink, server) {
  if (!server) server = cosmicLink.server
  const transaction = await cosmicLink.getTransaction()
  const response = server.submitTransaction(transaction)
  response.catch(console.log)
  return response
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
